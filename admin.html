<!doctype html>
<html>
<head><meta charset="utf-8"/><title>Admin Panel</title><link rel="stylesheet" href="style.css" /></head>
<body>
  <main style="padding:24px;">
    <h1>Admin Panel</h1>
    <div>
      <input id="adminPass" placeholder="Admin password" />
      <button id="adminLogin" class="btn">Login as Admin</button>
    </div>
    <section style="margin-top:18px;">
      <h2>Users</h2>
      <table id="usersTable" border="1" style="width:100%;background:#fff;color:#000"></table>
    </section>
    <section style="margin-top:18px;">
      <h2>Withdrawals</h2>
      <table id="withdrawTable" border="1" style="width:100%;background:#fff;color:#000"></table>
    </section>
  </main>
<script>
  let adminToken = null;
  document.getElementById('adminLogin').onclick = async () => {
    const pw = document.getElementById('adminPass').value;
    const res = await fetch('/api/admin/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ password: pw })});
    const j = await res.json();
    if (!j.ok) return alert('Bad password');
    adminToken = j.token; localStorage.setItem('adminToken', adminToken);
    loadUsers(); loadWithdrawals();
  };
  async function loadUsers(){
    const res = await fetch('/api/admin/users', { headers:{ 'x-admin-token': adminToken }});
    const j = await res.json();
    const table = document.getElementById('usersTable');
    table.innerHTML = '<tr><th>Username</th><th>Phone</th><th>Email</th><th>Balance</th></tr>';
    j.users.forEach(u => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${u.username}</td><td>${u.phone}</td><td>${u.email}</td><td>${u.balance}</td>`;
      table.appendChild(row);
    });
  }
  async function loadWithdrawals(){
    const res = await fetch('/api/admin/withdrawals', { headers:{ 'x-admin-token': adminToken }});
    const j = await res.json();
    const table = document.getElementById('withdrawTable');
    table.innerHTML = '<tr><th>User</th><th>Amount</th><th>Method</th><th>Status</th><th>Action</th></tr>';
    j.withdrawals.forEach(w=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${w.userPhone}</td><td>â‚¹${w.amount}</td><td>${w.method}</td><td>${w.status}</td><td></td>`;
      const approveBtn = document.createElement('button'); approveBtn.innerText='Approve';
      const rejectBtn = document.createElement('button'); rejectBtn.innerText='Reject';
      approveBtn.onclick = ()=> processW(w.id,'approve');
      rejectBtn.onclick = ()=> processW(w.id,'reject');
      tr.children[4].appendChild(approveBtn); tr.children[4].appendChild(rejectBtn);
      table.appendChild(tr);
    });
  }
  async function processW(id, action){
    const res = await fetch('/api/admin/withdrawals/'+id+'/process', { method:'POST', headers:{ 'Content-Type':'application/json','x-admin-token': adminToken }, body: JSON.stringify({ action })});
    const j = await res.json();
    if (!j.ok) return alert(j.message || 'Error');
    alert('Processed'); loadUsers(); loadWithdrawals();
  }
</script>
</body>
</html>